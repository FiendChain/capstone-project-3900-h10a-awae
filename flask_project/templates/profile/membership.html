{% extends 'base.html' %}
{% from "utility.html" import format_price %}

{% block head %}
<title>Membership</title>
{% endblock %}

{% block content %}
{% include 'user_navbar.html' %}

<div class="container-fluid justify-content-md-center text-center border-bottom pb-0 mb-3">
  <nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
    <ol class="breadcrumb mb-2">
      <li class="breadcrumb-item"><a href="{{ url_for('user_bp.home') }}">Home</a></li>
      <li class="breadcrumb-item"><a href="{{ url_for('user_bp.profile') }}">Profile</a></li>
      <li class="breadcrumb-item active">Membership</li>
    </ol>
  </nav>
</div>

<script src="/static/js/wtf_ajax_form.js"></script>

<div class="container w-75">
  <h3>Membership</h3>
  <p>Level: {{ current_cafepass.level }}</p>
  <p>Net xp: {{ current_cafepass.net_xp }}</p>
  <p>XP to next level: {{ current_cafepass.curr_level_info.xp }}</p>
  <p>Discount: {{ "%.2f"|format(current_cafepass.percent_discount) }}%</p>
  <p>Level progress: {{ "%.2f"|format(current_cafepass.percent_complete) }}%</p>
  <p>Previous milestone: {{ format_price(current_cafepass.prev_milestone) }}</p>
  <p>Current milestone: {{ format_price(current_cafepass.curr_milestone) }}</p>
  <p>Paid battlepass: {{"Yes" if current_cafepass.paid else "No"}}</p>
  

  <form action="{{ url_for('api_bp.profile_membership') }}" method='POST'>
    {{ cafepass_form.csrf_token }}

  </form>
</div>

<script>
  $("document").ready(function() {
    let form = $("form#payment-information");
  
    {% if default_billing_info %}
    $("#prefill-shipping-default").on("click", function(ev) {
      form.find("#country").val("{{ default_billing_info.country }}");
      form.find("#state").val("{{ default_billing_info.state }}");
      form.find("#address").val("{{ default_billing_info.address }}");
      form.find("#zip_code").val("{{ default_billing_info.zip_code }}");
    });
    {% endif %}
  
    {% if default_payment_info %}
    $("#prefill-cc-default").on("click", function(ev) {
      form.find("#cc_name").val("Guest Name");
      form.find("#cc_number").val("4242 4242 4242 4242");
      form.find("#cc_expiry").val("02 / 24");
      form.find("#cc_cvc").val("123");
    });
    {% endif %}
  
    payment_billing_form.card({
      container: '.card-wrapper', // *required*
      formSelectors: {
        numberInput: 'input#cc_number',
        expiryInput: 'input#cc_expiry',
        cvcInput: 'input#cc_cvc',
        nameInput: 'input#cc_name',
      },
      width: 200,
      formatting: true,
      messages: {
        validDate: 'valid\ndate',
        monthYear: 'mm/yyyy',
      },
      placeholders: {
        number: '•••• •••• •••• ••••',
        name: 'Full Name',
        expiry: '••/••',
        cvc: '•••'
      },
      masks: {
        cardNumber: '•' // optional - mask card number
      },
      debug: true
    })
  });
  </script>


<!--Payment information-->
<br>
{% if not current_cafepass.paid %}
<div class="container">
  <div class="row mx-4 justify-content-left">
    <!--Checkout form-->
    <div class="col-7 mb-4 px-4">
      <form role="form" class="wtf-ajax-form" id="payment-information" action="{{ url_for("api_bp.profile_membership", checkout_id=checkout_id) }}" method="POST">
        <!--Shipping form-->
        {{ form.csrf_token }}
        <div class="row">
          <div class="col text-start">
            <h6>Shipping Information</h6>
          </div>
          {% if default_billing_info %}
          <div class="col-auto text-end">
            <div class="btn btn-link btn-sm" id="prefill-shipping-default">Use default</div>
          </div>
          {% endif %}
        </div>
        <div class="row">
          <div class="col input-group">
            <select type="text" name="{{ form.country.id }}" id="{{ form.country.id }}" class="form-select" placeholder="Country" required>
              <option value="Australia" selected>Australia</option>
            </select>
            <div class="invalid-tooltip wtf-ajax-error d-none" id="{{ form.country.id }}"></div>
          </div>
        </div>
        <div class="row">
          <div class="col input-group">
            <input type="text" name="{{ form.address.id }}" id="{{ form.address.id }}" class="form-control" placeholder="Address" required>
            <div class="invalid-tooltip wtf-ajax-error d-none" id="{{ form.address.id }}"></div>
          </div>
        </div>
        <div class="row">
          <div class="col input-group">
            <select type="text" name="{{ form.state.id }}" id="{{ form.state.id }}" class="form-select" placeholder="State" required>
              {% for state in valid_states %}
              <option value="{{ state }}" selected>{{ state }}</option>
              {% endfor %}
            </select>
            <div class="invalid-tooltip wtf-ajax-error d-none" id="{{ form.state.id }}"></div>
          </div>
        </div>
        <div class="row">
          <div class="col input-group">
            <input type="text" name="{{ form.zip_code.id }}" id="{{ form.zip_code.id }}" class="form-control" placeholder="Zip Code" minlength="4" maxlength="4" required>
            <div class="invalid-tooltip wtf-ajax-error d-none" id="{{ form.zip_code.id }}"></div>
          </div>
        </div>
        {% if current_user.is_authenticated %}
        <div class="row my-1">
          <div class="col-auto">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" name="{{ form.remember_billing.id }}" id="{{ form.remember_billing.id }}" checked>
              <label class="form-check-label" for="{{ form.remember_billing.id }}">Save billing information</label>
            </div> 
          </div>
        </div>
        {% endif %}

        <!--Payment Form-->
        <div class="mt-3"></div>
        <div class="row">
          <div class="col mx-0 text-start">
            <h6>Payment Information</h6>
          </div>
          {% if default_payment_info %}
          <div class="col-auto mx-0 text-end">
            <div class="btn btn-link btn-sm" id="prefill-cc-default">Use default</div>
          </div>
          {% endif %}
        </div>
        <div class="card-wrapper"></div>
        <div class="row">
          <div class="col input-group">
            <input type="text" name="{{ form.cc_name.id }}" id="{{ form.cc_name.id }}" class="form-control" placeholder="Full Name" required>
            <div class="invalid-tooltip wtf-ajax-error d-none" id="{{ form.cc_name.id }}"></div>
          </div>
        </div>
        <div class="row">
          <div class="col input-group">
            <input type="text" name="{{ form.cc_number.id }}" id="{{ form.cc_number.id }}" class="form-control" min="19" max="19" placeholder="•••• •••• •••• ••••" required>
            <div class="invalid-tooltip wtf-ajax-error d-none" id="{{ form.cc_number.id }}"></div>
          </div>
        </div>
        <div class="row">
          <div class="col input-group pe-0">
            <input type="text" name="{{ form.cc_expiry.id }}" id="{{ form.cc_expiry.id }}" class="form-control" min="" max="7" placeholder="••/••" required>
            <div class="invalid-tooltip wtf-ajax-error d-none" id="{{ form.cc_expiry.id }}"></div>
          </div>
          <div class="col input-group ps-0">
            <input type="text" name="{{ form.cc_cvc.id }}" id="{{ form.cc_cvc.id }}" class="form-control" placeholder="•••" required>
            <div class="invalid-tooltip wtf-ajax-error d-none" id="{{ form.cc_cvc.id }}"></div>
          </div>
        </div>
        {% if current_user.is_authenticated %}
        <div class="row my-1">
          <div class="col-auto">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" name="{{ form.remember_payment.id }}" id="{{ form.remember_payment.id }}" checked>
              <label class="form-check-label" for="{{ form.remember_payment.id }}">Save payment information</label>
            </div> 
          </div>
        </div>
        {% endif %}
        <button type="submit" class="btn btn-success w-100" form="payment-information">
          <strong>Upgrade to paid cafepass for $20!</strong>
        </button>
      </form>
    </div>
  </div>
</div>
{% endif %}
{% endblock %}